<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Byte & Block Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --card: #ffffff;
        --border: #e5e7eb;
        --chip: #f3f4f6;
        --accent: #111827;
        --good: #16a34a;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        padding: 16px;
        color: var(--text);
        background: var(--bg);
      }

      h1 {
        font-size: 22px;
        margin: 0 0 10px 0;
      }

      .top {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 12px;
      }

      .pill {
        display: flex;
        gap: 10px;
        align-items: center;
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 14px;
        padding: 12px;
      }

      .pill b { font-weight: 700; }
      .muted { color: var(--muted); }

      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 10px 0 12px 0;
      }

      .tab {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--chip);
        cursor: pointer;
        user-select: none;
        font-weight: 600;
      }

      .tab.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .card {
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 16px;
        padding: 12px;
        margin-bottom: 10px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        font-weight: 800;
        font-size: 16px;
      }

      .sub {
        margin-top: 4px;
        color: var(--muted);
        font-size: 13px;
      }

      .kv {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 6px 12px;
        font-size: 14px;
      }

      .btn {
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        font-weight: 700;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .error {
        color: #b91c1c;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        margin-top: 8px;
      }

      .code {
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        color: #111827;
        background: #f9fafb;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <h1>Byte & Block</h1>

    <div class="top">
      <div class="pill">
        <div>
          <div><b>Status:</b> <span id="status">Loading‚Ä¶</span></div>
          <div class="muted"><b>Platform:</b> <span id="platform"></span></div>
          <div class="muted"><b>User ID:</b> <span id="uid">‚Äî</span></div>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div style="font-weight:800; color:var(--good);">‚úÖ</div>
          <div class="muted" style="font-size:12px;">connected</div>
        </div>
      </div>

      <button class="btn" id="refreshBtn">Refresh data</button>

      <div class="tabs">
        <div class="tab active" data-tab="portfolio">Portfolio</div>
        <div class="tab" data-tab="alerts">Alerts</div>
        <div class="tab" data-tab="settings">Settings</div>
        <div class="tab" data-tab="debug">Debug</div>
      </div>
    </div>

    <div id="content"></div>

    <script>
      const tg = window.Telegram?.WebApp;

      const state = {
        tab: "portfolio",
        me: null,
        portfolio: null,
        alerts: null,
        settings: null,
        meta: null,            // <-- NEW
        saving: false,         // <-- NEW
        saveMsg: "",           // <-- NEW
        debug: "",
      };

      function fmtNumber(n, decimals = 4) {
        const x = Number(n);
        if (!Number.isFinite(x)) return "‚Äî";
        return x.toLocaleString(undefined, { maximumFractionDigits: decimals });
      }

      function fmtMoney(n, currency = "USD") {
        const x = Number(n);
        if (!Number.isFinite(x)) return "‚Äî";
        try {
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currency,
            maximumFractionDigits: 2,
          }).format(x);
        } catch {
          return `${x.toFixed(2)} ${currency}`;
        }
      }

      function setStatus() {
        document.getElementById("platform").textContent = tg ? tg.platform : "(not in Telegram)";
        document.getElementById("status").textContent = tg ? "Running inside Telegram ‚úÖ" : "Not inside Telegram ‚ùå";
      }

      async function callApi(path, opts = {}) {
        if (!tg) throw new Error("Open this inside Telegram as a Mini App.");

        tg.ready();
        tg.expand();

        const initData = tg.initData;
        if (!initData) throw new Error("No initData. Open via Bot menu button / configured Mini App.");

        const method = (opts.method || "GET").toUpperCase();
        const headers = {
          "X-Telegram-Init-Data": initData,
        };

        let body;
        if (opts.body !== undefined) {
          headers["Content-Type"] = "application/json";
          body = JSON.stringify(opts.body);
        }

        const res = await fetch("https://api.byteandblock.com" + path, {
          method,
          headers,
          body,
        });

        const text = await res.text();
        state.debug = `${method} ${path}\nHTTP ${res.status}\n\n${text}`;

        if (!res.ok) throw new Error(`HTTP ${res.status}\n\n${text}`);

        try {
          return JSON.parse(text);
        } catch {
          throw new Error("API returned non-JSON:\n\n" + text);
        }
      }

      async function callPublic(path) {
        const res = await fetch("https://api.byteandblock.com" + path);
        const text = await res.text();
        state.debug = `GET ${path}\nHTTP ${res.status}\n\n${text}`;
        if (!res.ok) throw new Error(`HTTP ${res.status}\n\n${text}`);
        return JSON.parse(text);
      }

      function render() {
        const el = document.getElementById("content");
        el.innerHTML = "";

        if (state.tab === "portfolio") {
          renderPortfolio(el);
        } else if (state.tab === "alerts") {
          renderAlerts(el);
        } else if (state.tab === "settings") {
          renderSettings(el);
        } else {
          renderDebug(el);
        }
      }

      function renderPortfolio(root) {
        const payload = state.portfolio;
        const positions = payload?.positions;
        const totals = payload?.totals;
        const currency = payload?.currency || (state.settings?.settings?.currency ?? "USD");

        if (!positions || !Array.isArray(positions) || positions.length === 0) {
          root.appendChild(card("Portfolio is empty.", "Use your bot to /add positions for now."));
          return;
        }

        // Totals card
        const totalCard = document.createElement("div");
        totalCard.className = "card";

        const pnlAbs = Number(totals?.pnlAbs) || 0;
        const pnlPct = Number(totals?.pnlPct) || 0;

        totalCard.innerHTML = `
          <div class="row">
            <div>
              <div class="title">Portfolio total</div>
              <div class="sub">Live value + PnL (CoinGecko)</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:900;">${fmtMoney(Number(totals?.value) || 0, currency)}</div>
              <div class="sub">${pnlAbs >= 0 ? "üü¢" : "üî¥"} ${fmtMoney(pnlAbs, currency)} (${pnlPct.toFixed(2)}%)</div>
            </div>
          </div>
        `;
        root.appendChild(totalCard);

        // Position cards
        for (const p of positions) {
          const name = p.name || p.symbol || "Unknown";
          const symbol = p.symbol ? `(${p.symbol})` : "";
          const amount = Number(p.amount) || 0;

          const currentPrice = p.currentPrice;
          const value = p.value;
          const posPnlAbs = p.pnlAbs;
          const posPnlPct = p.pnlPct;

          const c = document.createElement("div");
          c.className = "card";

          const rightTop = (value != null) ? fmtMoney(value, currency) : "‚Äî";
          const rightMid = (currentPrice != null) ? fmtMoney(currentPrice, currency) : "‚Äî";

          let pnlLine = "‚Äî";
          if (posPnlAbs != null && posPnlPct != null) {
            const sign = posPnlAbs >= 0 ? "üü¢" : "üî¥";
            pnlLine = `${sign} ${fmtMoney(posPnlAbs, currency)} (${Number(posPnlPct).toFixed(2)}%)`;
          }

          c.innerHTML = `
            <div class="row">
              <div>
                <div class="title">${escapeHtml(name)} ${escapeHtml(symbol)}</div>
                <div class="sub">Token ID: ${escapeHtml(p.tokenId || "‚Äî")}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-weight:900;">${rightTop}</div>
                <div class="sub">${pnlLine}</div>
              </div>
            </div>

            <div class="kv">
              <div class="muted">Amount</div><div>${fmtNumber(amount, 6)}</div>
              <div class="muted">Avg entry</div><div>${fmtMoney(Number(p.avgEntry) || 0, currency)}</div>
              <div class="muted">Current price</div><div>${rightMid}</div>
              <div class="muted">24h change</div><div>${(Number(p.change24h) || 0).toFixed(2)}%</div>
            </div>
          `;

          root.appendChild(c);
        }
      }

      function renderAlerts(root) {
        const data = state.alerts?.alerts;

        if (!data || !Array.isArray(data) || data.length === 0) {
          root.appendChild(card("No alerts configured.", "Use /alert in the bot for now. We'll add UI actions later."));
          return;
        }

        // New: pretty cards
        for (const a of data) {
          const sym = a.tokenSymbol || "‚Äî";
          const mode = a.mode || "‚Äî";
          const modeLabel =
            mode === "volatility" ? "Volatility" :
            mode === "newsvol" ? "News + Volatility" :
            mode;
          const target = (a.target != null) ? a.target : "‚Äî";
          const window = a.window || "‚Äî";
          const currency = a.currency || (state.settings?.settings?.currency ?? "USD");

          let headline = `Alert for ${sym}`;
          let line = "";

          if (mode === "newsvol") {
            line = `${sym} moves more than ${target}% in ${window} with a news spike`;
          } else if (mode === "volatility") {
            line = `${sym} moves more than ${target}% in ${window}`;
          } else if (mode === "price") {
            // if you ever add price alerts later
            line = `${sym} price alert (${currency})`;
          } else if (mode === "percent") {
            line = `${sym} percent alert`;
          } else if (mode === "range") {
            line = `${sym} range alert (${currency})`;
          } else {
            line = `${sym} alert (${mode})`;
          }

          const created = a.createdAt ? new Date(a.createdAt).toLocaleString() : "‚Äî";

          const c = document.createElement("div");
          c.className = "card";

          c.innerHTML = `
            <div class="row">
              <div>
                <div class="title">üîî ${escapeHtml(headline)}</div>
                <div class="sub">${escapeHtml(line)}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-weight:800;">${escapeHtml(String(target))}%</div>
                <div class="sub">${escapeHtml(window)}</div>
              </div>
            </div>

            <div class="kv">
              <div class="muted">Type</div><div>${escapeHtml(modeLabel)}</div>
              <div class="muted">Currency</div><div>${escapeHtml(currency)}</div>
              <div class="muted">Created</div><div>${escapeHtml(created)}</div>
            </div>
          `;

          root.appendChild(c);
        }
      }

      function renderSettings(root) {
        const s = state.settings?.settings;
        const meta = state.meta;

        if (!s) {
          root.appendChild(card("No settings loaded.", "Tap Refresh data."));
          return;
        }

        const currencies = meta?.supportedCurrencies || ["USD"];
        const exchanges = meta?.supportedExchanges || ["binance"];

        const currentCurrency = s.currency || "USD";
        const currentExchange = s.exchange || "binance";

        const c = document.createElement("div");
        c.className = "card";

        c.innerHTML = `
          <div class="title">Settings</div>
          <div class="sub">Change currency/exchange and tap Save.</div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:160px;">
              <div class="muted" style="font-size:13px; margin-bottom:6px;">Currency</div>
              <select id="currencySel" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border);">
                ${currencies.map(x => `<option value="${escapeHtml(x)}"${x === currentCurrency ? " selected" : ""}>${escapeHtml(x)}</option>`).join("")}
              </select>
            </div>

            <div style="flex:1; min-width:160px;">
              <div class="muted" style="font-size:13px; margin-bottom:6px;">Exchange</div>
              <select id="exchangeSel" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border);">
                ${exchanges.map(x => `<option value="${escapeHtml(x)}"${x === currentExchange ? " selected" : ""}>${escapeHtml(x)}</option>`).join("")}
              </select>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
            <button class="btn" id="saveSettingsBtn" ${state.saving ? "disabled" : ""} style="width:auto; padding:10px 14px;">
              ${state.saving ? "Saving‚Ä¶" : "Save"}
            </button>
            <div class="muted" id="saveMsg" style="font-size:13px;">${escapeHtml(state.saveMsg || "")}</div>
          </div>
        `;

        root.appendChild(c);

        // Wire up Save button
        const btn = c.querySelector("#saveSettingsBtn");
        btn.addEventListener("click", async () => {
          const currency = c.querySelector("#currencySel").value;
          const exchange = c.querySelector("#exchangeSel").value;

          state.saving = true;
          state.saveMsg = "";
          render();

          try {
            // POST to your API (server must support this route)
            await callApi("/api/settings", {
              method: "POST",
              body: { currency, exchange },
            });

            // re-fetch so UI reflects saved state
            state.settings = await callApi("/api/settings");

            state.saveMsg = "Saved ‚úÖ";
          } catch (e) {
            state.saveMsg = "Save failed ‚ùå (check Debug tab)";
          } finally {
            state.saving = false;
            render();
          }
        });
      }

      function renderDebug(root) {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `<div class="title">Debug</div><div class="sub">Last API response:</div>`;
        const pre = document.createElement("div");
        pre.className = "code";
        pre.textContent = state.debug || "(nothing yet)";
        c.appendChild(pre);
        root.appendChild(c);
      }

      function card(title, subtitle) {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `<div class="title">${escapeHtml(title)}</div><div class="sub">${escapeHtml(subtitle || "")}</div>`;
        return c;
      }

      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function refreshAll() {
        const btn = document.getElementById("refreshBtn");
        btn.disabled = true;
        btn.textContent = "Refreshing‚Ä¶";

        try {
          const me = await callApi("/api/me");
          state.me = me;
          document.getElementById("uid").textContent = me?.user?.id ?? "‚Äî";

          // Load settings first (for currency display)
          state.meta = await callPublic("/api/meta");
          state.settings = await callApi("/api/settings");
          state.portfolio = await callApi("/api/portfolio/enriched");
          state.alerts = await callApi("/api/alerts");

          btn.textContent = "Refresh data";
          render();
        } catch (err) {
          btn.textContent = "Refresh data";
          const root = document.getElementById("content");
          root.innerHTML = "";
          const c = document.createElement("div");
          c.className = "card";
          c.innerHTML = `<div class="title">Error</div><div class="error">${escapeHtml(err.message)}</div>`;
          root.appendChild(c);
        } finally {
          btn.disabled = false;
        }
      }

      // Tabs
      document.querySelectorAll(".tab").forEach((t) => {
        t.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach((x) => x.classList.remove("active"));
          t.classList.add("active");
          state.tab = t.dataset.tab;
          render();
        });
      });

      document.getElementById("refreshBtn").addEventListener("click", refreshAll);

      setStatus();
      // Auto-load once
      refreshAll();
    </script>
  </body>
</html>
